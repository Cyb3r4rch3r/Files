#Script written to detect and alert to the presence of malicious activity related to known attack.
#More information at  https://www.us-cert.gov/ncas/alerts/TA18-074A

Write-Host "This script checks for the presence of modiications to the system indicative of a known recent attack. If these return values other than false, please contact Information Security IMMEDIATELY!"

$shareName = Read-Host -Prompt "Which Share would you like to search?: "


function fileCheck()
	{
	$fileName = "enu.cmd"
	Write-Host "Searching for $fileName"
	Get-Childitem -Path \\$shareName\c$\ -Include $fileName -File -Recurse -force  -ErrorAction SilentlyContinue | Format-Table -Autosize -Property fullName, LastWriteTime
	}
	

function regTest()	
	{
	Write-Host "Searching for associated Registry Modifications: "
	if (test-Connection -Cn $shareName -Count 2 -quiet) {
	write-host "$shareName is online. Checking for Registry Entry."
	Test-Path "\\$shareName\HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest"
	}
	else
	{ write-host "$shareName is not online."}

    }

function checkService()
	{
	$servName = Get-Service -Name termservice
	if ($servName.Status -eq "Running"){
	Write-Host "Terminal Service is running. Checking connections for IP addresses."}
	else
	{Write-Host "Terminal Service is not running."}
	qwinsta /SERVER:$shareName
	write-host "Please review the IP's listed to ensure they are expected, otherwise contact Information Security immediately."
	}
	
function userAudit()
	{
	Write-Host "Checking for the presence of malicious user account"
	if (Test-Path "\\$shareName\c$\users\ms_backup") {
	Write-Host "Malicious user account found! Contact Information Security Immediately!"}
	else
	{Write-Host "No malicious account found."}
	}
	
regTest
checkService
userAudit
fileCheck
